trigger:
  branches:
    include:
      - main

variables:
  SONAR_TOKEN: $(SONAR_TOKEN)
  SONAR_PROJECT_KEY: pramod-2014_cloudsurge-web
  SONAR_ORG: my-organization-key

pool: 
  name: "devPool"
  demands:
    - Agent.Name -equals hommelap7480   

stages:

  # ================== SCAN STAGE ==================
  - stage: Scan
    displayName: "Scan with SonarCloud"
    jobs:
      - job: ScanJob
        displayName: "SonarCloud Scan"
        steps:

          # Step 1: Prepare SonarCloud analysis
          - task: SonarCloudPrepare@4
            inputs:
              SonarQube: 'sonarqube-service-connection'
              organization: '$(SONAR_ORG)'
              scannerMode: 'dotnet'
              projectKey: '$(SONAR_PROJECT_KEY)'
              projectName: 'cloudsurge-web'

          # Step 2: Run the analysis
          - task: SonarCloudAnalyze@4

          # Step 3: Publish results to SonarCloud
          - task: SonarCloudPublish@4
            inputs:
              pollingTimeoutSec: '300'

  # ================== BUILD STAGE ==================
  - stage: Build
    displayName: "Build Stage"
    jobs:

      # Job 1: Install NPM dependencies
      - job: Build
        displayName: "Install Dependencies"
        steps:
          - task: Npm@1
            inputs:
              command: 'install'
              workingDir: '$(System.DefaultWorkingDirectory)/cloudsurge-web'

      # Job 2: Run NPM build
      - job: NpmRun
        displayName: "Run npm build"
        steps:
          - task: Npm@1
            inputs:
              command: 'custom'
              workingDir: '$(System.DefaultWorkingDirectory)/cloudsurge-web'
              customCommand: 'npm run build'

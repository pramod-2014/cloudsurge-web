

trigger:
  branches:
    include:
      - main

pool: 
  name: "Infra-Runners-pool"
  demands:
    - agent.name -equals kmaster
 
variables:
  dockerRegistryServiceConnection: 'DockerHubConnection' 
  imageRepository: 'prmd77/cloudsurgeimag'                  
  dockerfilePath: '$(Build.SourcesDirectory)/Dockerfile'
  tag: '$(Build.BuildId)'
  manifestsFolder: 'Deployment.yaml'
  aksServiceConnection: 'aks-service-connection'            

stages:
- stage: Build_and_Push
  displayName: "Build & Push Docker Image"
  jobs:
  - job: Build

    steps:
    

    - task: NodeTool@0
      inputs:
        versionSpec: '18.x'   # Node version for build
      displayName: 'Install Node.js'

    - script: |
        cd cloudsurge-web
        npm install
        npm run build
      displayName: 'Install dependencies & Build app'

    - task: Docker@2
      displayName: 'Build and Push Docker image'
      inputs:
        containerRegistry: $(dockerRegistryServiceConnection)
        repository: $(imageRepository)
        command: 'buildAndPush'
        Dockerfile: $(dockerfilePath)
      

- stage: Deploy_to_AKS
  displayName: "Deploy to AKS"
  dependsOn: Build_and_Push
  jobs:
  - job: Deploy
    pool:
        name: "Infra-Runners-pool"
        demands:
             - agent.name -equals kmaster
    steps:
    - checkout: self

    - task: KubernetesManifest@0
      displayName: 'Deploy manfests to AKS'
      inputs:
        action: deploy
        kubernetesServiceConnection: $(aksServiceConnection)
        namespace: default
        manifests: |
          $(manifestsFolder)
      env:
        DOCKER_IMAGE: "prmd77/cloudsurgeimag:311"

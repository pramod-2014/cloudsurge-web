

trigger:
  branches:
    include:
      - main

pool: 
  name: "Infra-Runners-pool"
  demands:
    - agent.name -equals office
 
variables:
  dockerRegistryServiceConnection: 'DockerHubConnection' 
  imageRepository: 'prmd77/cloudsurgeimag'                  # Docker Hub repo name
  dockerfilePath: 'cloudsurge-web-main/manifests/Dockerfile'
  tag: '$(Build.BuildId)'
  manifestsFolder: 'cloudsurge-web-main/manifests'
  aksServiceConnection: 'aks-service-connection'            # Tumhara AKS service connection

stages:
- stage: Build_and_Push
  displayName: "Build & Push Docker Image"
  jobs:
  - job: Build
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - checkout: self

    - task: NodeTool@0
      inputs:
        versionSpec: '18.x'   # Node version for build
      displayName: 'Install Node.js'

    - script: |
        cd cloudsurge-web-main
        npm install
        npm run build
      displayName: 'Install dependencies & Build app'

    - task: Docker@2
      displayName: 'Build and Push Docker image'
      inputs:
        containerRegistry: $(dockerRegistryServiceConnection)
        repository: $(imageRepository)
        command: 'buildAndPush'
        Dockerfile: $(dockerfilePath)
        tags: |
          $(tag)

- stage: Deploy_to_AKS
  displayName: "Deploy to AKS"
  dependsOn: Build_and_Push
  jobs:
  - job: Deploy
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - checkout: self

    - task: KubernetesManifest@0
      displayName: 'Deploy manifests to AKS'
      inputs:
        action: deploy
        kubernetesServiceConnection: $(aksServiceConnection)
        namespace: default
        manifests: |
          $(manifestsFolder)/Deployment.yaml
      env:
        DOCKER_IMAGE: "$(imageRepository):$(tag)"
